<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container" style="width: 550px;">
    <h2 id="userName">Loading...</h2>
    <p id="userEmail"></p>
    <p id="eventsAttended"></p>

    <h3>Your Registered Events</h3>
    <ul id="registeredEvents"></ul>

    <h3>Available Events</h3>
    <ul id="availableEvents"></ul>

    <button onclick="logout()" style="background:#f44336;">Logout</button>
</div>

<script>
    let eventsAttendedCount = 0;

// Function to update counter on page
function updateEventsAttendedDisplay() {
    document.getElementById("eventsAttended").innerText = `Events Attended: ${eventsAttendedCount}`;
}

// Function to load dashboard for a user
function loadDashboard(user) {
    document.getElementById("userName").innerText = `Welcome, ${user.name}`;
    document.getElementById("userEmail").innerText = `Logged in as: ${user.email}`;

    eventsAttendedCount = user.registeredEvents.length;
    updateEventsAttendedDisplay();

    // Registered Events
    let regList = document.getElementById("registeredEvents");
    regList.innerHTML = "";
    user.registeredEvents.forEach(event => {
        let li = document.createElement("li");
        li.innerText = `${event.title} - ${event.date}`;
        regList.appendChild(li);
    });

    // Available Events
    let availList = document.getElementById("availableEvents");
    availList.innerHTML = "";
    user.availableEvents.forEach(event => {
        let li = document.createElement("li");
        li.innerHTML = `${event.title} - ${event.date}
            <button onclick="registerEvent(${event.id}, '${event.title}', '${event.date}')">Register</button>`;
        availList.appendChild(li);
    });
}

// Function to register for an event dynamically
function registerEvent(eventId, title, date) {
    fetch(`http://localhost:8080/api/users/${window.currentUserId}/registerEvent/${eventId}`, { method: "POST" })
        .then(res => res.text())
        .then(msg => {
            alert(msg);

            // Increase counter
            eventsAttendedCount++;
            updateEventsAttendedDisplay();

            // Add to registered list
            let regList = document.getElementById("registeredEvents");
            let li = document.createElement("li");
            li.innerText = `${title} - ${date}`;
            regList.appendChild(li);

            // Remove from available list
            const availList = document.getElementById("availableEvents");
            availList.innerHTML = availList.innerHTML.replace(
                new RegExp(`<li>.*${title}.*</li>`), ''
            );
        });
}

// Logout function
function logout() {
    fetch("http://localhost:8080/logout", { method: "POST" })
        .then(() => {
            localStorage.clear();
            window.location.href = "login.html";
        });
}

// --- Login detection logic ---
let userId = localStorage.getItem("userId");

if (userId) {
    // Form Login
    window.currentUserId = userId;
    fetch(`http://localhost:8080/api/users/${userId}/dashboard`)
        .then(res => res.json())
        .then(data => {
            loadDashboard(data);
        });
} else {
    // Google OAuth Login
    fetch(`http://localhost:8080/api/users/me`)
        .then(res => res.json())
        .then(data => {
            window.currentUserId = data.id; // store user id for event registration
            loadDashboard(data);
        })
        .catch(() => {
            alert("Not logged in");
            window.location.href = "login.html";
        });
}
</script>
</body>
</html>
